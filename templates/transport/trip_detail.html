{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Chi tiết chuyến xe - ReHearten{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12 mb-4">
            <a href="/trips/" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Trip Information -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Thông tin chuyến xe
                    </h5>
                </div>
                <div class="card-body" id="tripInfo">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Selection -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chair me-2"></i>Chọn ghế
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Seat Legend -->
                    <div class="seat-legend mb-4">
                        <div class="row">
                            <div class="col-4">
                                <span class="seat-demo available"></span>
                                <span class="ms-2">Còn trống</span>
                            </div>
                            <div class="col-4">
                                <span class="seat-demo selected"></span>
                                <span class="ms-2">Đang chọn</span>
                            </div>
                            <div class="col-4">
                                <span class="seat-demo booked"></span>
                                <span class="ms-2">Đã đặt</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bus Layout -->
                    <div class="bus-container">
                        <div class="bus-driver mb-3">
                            <i class="fas fa-steering-wheel"></i>
                            <span class="ms-2">Tài xế</span>
                        </div>
                        <div id="seatMap" class="seat-map">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="col-md-5">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>Thông tin đặt vé
                    </h5>
                </div>
                <div class="card-body">
                    <div id="selectedSeatsInfo" class="mb-3">
                        <p class="text-muted">Chưa chọn ghế nào</p>
                    </div>

                    <hr>

                    <div id="passengerInfo" style="display: none;">
                        <h6 class="mb-3">Thông tin hành khách</h6>
                        <div id="passengerForms"></div>
                        <hr>
                    </div>

                    <div class="booking-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Số ghế:</span>
                            <strong id="totalSeats">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Giá mỗi ghế:</span>
                            <strong id="pricePerSeat">0 ₫</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Tổng tiền:</h6>
                            <h5 class="text-primary mb-0" id="totalAmount">0 ₫</h5>
                        </div>

                        <button id="bookNowBtn" class="btn btn-primary w-100 btn-lg" disabled>
                            <i class="fas fa-ticket-alt me-2"></i>Đặt vé ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .seat-legend {
        background: #f8fafc;
        padding: 15px;
        border-radius: 10px;
    }

    .seat-demo {
        display: inline-block;
        width: 35px;
        height: 35px;
        border-radius: 8px;
        border: 2px solid #cbd5e1;
        vertical-align: middle;
    }

    .seat-demo.available {
        background: white;
        border-color: #0ea5e9;
    }

    .seat-demo.selected {
        background: linear-gradient(135deg, #0ea5e9, #38bdf8);
        border-color: #0284c7;
    }

    .seat-demo.booked {
        background: #e2e8f0;
        border-color: #94a3b8;
    }

    .bus-container {
        background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
        padding: 20px;
        border-radius: 15px;
        border: 3px solid #e2e8f0;
    }

    .bus-driver {
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border-radius: 10px;
        font-weight: 600;
        color: #075985;
    }

    .seat-map {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        max-width: 400px;
        margin: 0 auto;
    }

    .seat {
        aspect-ratio: 1;
        border-radius: 10px;
        border: 2px solid #cbd5e1;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #475569;
        position: relative;
    }

    .seat:hover:not(.booked) {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
    }

    .seat.available {
        border-color: #0ea5e9;
    }

    .seat.available:hover {
        background: #e0f2fe;
    }

    .seat.selected {
        background: linear-gradient(135deg, #0ea5e9, #38bdf8);
        border-color: #0284c7;
        color: white;
        transform: scale(1.05);
    }

    .seat.booked {
        background: #e2e8f0;
        border-color: #94a3b8;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .seat i {
        font-size: 1.2rem;
    }

    .trip-route-big {
        display: flex;
        align-items: center;
        gap: 20px;
        margin: 20px 0;
    }

    .location-box {
        flex: 1;
        background: linear-gradient(135deg, #f0f9ff, #dbeafe);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .route-arrow-big {
        font-size: 2rem;
        color: #0ea5e9;
    }

    .passenger-form {
        margin-bottom: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }

    .passenger-form label {
        font-weight: 600;
        color: #475569;
        margin-bottom: 5px;
    }

    .sticky-top {
        position: sticky;
        top: 20px;
        z-index: 10;
    }
</style>

<script>
let tripData = null;
let seatsData = [];
let selectedSeats = [];
const tripId = {{ trip_id }};

document.addEventListener('DOMContentLoaded', function() {
    loadTripInfo();
    loadSeats();

    const bookNowBtn = document.getElementById('bookNowBtn');
    if (bookNowBtn) {
        bookNowBtn.addEventListener('click', createBooking);
    }
});

function loadTripInfo() {
    fetch(`/api/trips/${tripId}/`)
        .then(response => response.json())
        .then(trip => {
            tripData = trip;
            renderTripInfo(trip);
            updatePricePerSeat(trip.price_per_seat);
        })
        .catch(error => {
            console.error('Error loading trip:', error);
            document.getElementById('tripInfo').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Lỗi khi tải thông tin chuyến xe
                </div>
            `;
        });
}

function renderTripInfo(trip) {
    const departureDate = new Date(trip.departure_time);
    const arrivalDate = new Date(trip.arrival_time);

    const departureTimeStr = departureDate.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    const arrivalTimeStr = arrivalDate.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit'
    });
    const dateStr = departureDate.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        weekday: 'long'
    });

    const duration = (arrivalDate - departureDate) / (1000 * 60 * 60);
    const hours = Math.floor(duration);
    const minutes = Math.floor((duration - hours) * 60);

    document.getElementById('tripInfo').innerHTML = `
        <div class="trip-route-big">
            <div class="location-box">
                <div class="text-muted mb-2">Điểm đi</div>
                <h5 class="mb-0">${trip.start_location_name}</h5>
                <small>${trip.start_location_city}</small>
            </div>
            <i class="fas fa-arrow-right route-arrow-big"></i>
            <div class="location-box">
                <div class="text-muted mb-2">Điểm đến</div>
                <h5 class="mb-0">${trip.end_location_name}</h5>
                <small>${trip.end_location_city}</small>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <div class="info-box">
                    <i class="fas fa-calendar text-primary me-2"></i>
                    <strong>Ngày khởi hành:</strong><br>
                    <span class="ms-4">${dateStr}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box">
                    <i class="fas fa-clock text-primary me-2"></i>
                    <strong>Giờ khởi hành:</strong><br>
                    <span class="ms-4">${departureTimeStr}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box">
                    <i class="fas fa-hourglass-half text-primary me-2"></i>
                    <strong>Thời gian di chuyển:</strong><br>
                    <span class="ms-4">${hours} giờ ${minutes} phút</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-box">
                    <i class="fas fa-bus text-primary me-2"></i>
                    <strong>Xe:</strong><br>
                    <span class="ms-4">${trip.bus_model} (${trip.bus_license_plate})</span>
                </div>
            </div>
        </div>
    `;
}

function loadSeats() {
    fetch(`/api/trip/${tripId}/seats/`)
        .then(response => response.json())
        .then(data => {
            seatsData = data.seats;
            renderSeatMap(data.seats);
        })
        .catch(error => {
            console.error('Error loading seats:', error);
            document.getElementById('seatMap').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Lỗi khi tải sơ đồ ghế
                </div>
            `;
        });
}

function renderSeatMap(seats) {
    const seatMapHTML = seats.map(seat => {
        const statusClass = seat.is_booked ? 'booked' : 'available';
        const icon = seat.is_booked ? '<i class="fas fa-times"></i>' : '<i class="fas fa-chair"></i>';

        return `
            <div class="seat ${statusClass}"
                 data-seat-id="${seat.id}"
                 data-seat-number="${seat.seat_number}"
                 ${seat.is_booked ? 'title="Ghế đã được đặt"' : ''}>
                ${seat.seat_number}
            </div>
        `;
    }).join('');

    document.getElementById('seatMap').innerHTML = seatMapHTML;

    // Add click event listeners to available seats
    document.querySelectorAll('.seat.available').forEach(seat => {
        seat.addEventListener('click', function() {
            toggleSeatSelection(this);
        });
    });
}

function toggleSeatSelection(seatElement) {
    const seatId = parseInt(seatElement.dataset.seatId);
    const seatNumber = seatElement.dataset.seatNumber;

    if (seatElement.classList.contains('selected')) {
        // Deselect
        seatElement.classList.remove('selected');
        selectedSeats = selectedSeats.filter(s => s.id !== seatId);
    } else {
        // Select
        seatElement.classList.add('selected');
        selectedSeats.push({ id: seatId, number: seatNumber });
    }

    updateBookingSummary();
}

function updateBookingSummary() {
    const totalSeatsEl = document.getElementById('totalSeats');
    const totalAmountEl = document.getElementById('totalAmount');
    const selectedSeatsInfoEl = document.getElementById('selectedSeatsInfo');
    const bookNowBtn = document.getElementById('bookNowBtn');
    const passengerInfoEl = document.getElementById('passengerInfo');

    totalSeatsEl.textContent = selectedSeats.length;

    if (selectedSeats.length > 0 && tripData) {
        const total = selectedSeats.length * parseFloat(tripData.price_per_seat);
        totalAmountEl.textContent = total.toLocaleString('vi-VN') + ' ₫';

        const seatNumbers = selectedSeats.map(s => s.number).join(', ');
        selectedSeatsInfoEl.innerHTML = `
            <h6>Ghế đã chọn:</h6>
            <div class="badge bg-primary me-1 mb-1">${seatNumbers}</div>
        `;

        if (bookNowBtn) {
            bookNowBtn.disabled = false;
        }

        // Show passenger info forms
        renderPassengerForms();
        passengerInfoEl.style.display = 'block';
    } else {
        totalAmountEl.textContent = '0 ₫';
        selectedSeatsInfoEl.innerHTML = '<p class="text-muted">Chưa chọn ghế nào</p>';
        if (bookNowBtn) {
            bookNowBtn.disabled = true;
        }
        passengerInfoEl.style.display = 'none';
    }
}

function renderPassengerForms() {
    const passengerFormsEl = document.getElementById('passengerForms');
    const formsHTML = selectedSeats.map((seat, index) => `
        <div class="passenger-form">
            <label>Hành khách ghế ${seat.number}</label>
            <input type="text"
                   class="form-control passenger-name"
                   data-seat-index="${index}"
                   placeholder="Nhập họ tên"
                   value="">
        </div>
    `).join('');

    passengerFormsEl.innerHTML = formsHTML;
}

function updatePricePerSeat(price) {
    document.getElementById('pricePerSeat').textContent =
        parseFloat(price).toLocaleString('vi-VN') + ' ₫';
}

function createBooking() {
    if (selectedSeats.length === 0) {
        alert('Vui lòng chọn ít nhất một ghế');
        return;
    }

    // Get passenger names
    const passengerNames = [];
    document.querySelectorAll('.passenger-name').forEach(input => {
        passengerNames.push(input.value.trim());
    });

    // Prepare booking data
    const bookingData = {
        seat_ids: selectedSeats.map(s => s.id),
        passenger_names: passengerNames
    };

    // Show loading state
    const bookNowBtn = document.getElementById('bookNowBtn');
    const originalBtnText = bookNowBtn.innerHTML;
    bookNowBtn.disabled = true;
    bookNowBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';

    // Create booking
    fetch(`/booking/create/${tripId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alert('Lỗi: ' + (data.error || 'Không thể tạo booking'));
            bookNowBtn.disabled = false;
            bookNowBtn.innerHTML = originalBtnText;
        }
    })
    .catch(error => {
        console.error('Error creating booking:', error);
        alert('Có lỗi xảy ra khi đặt vé. Vui lòng thử lại sau.');
        bookNowBtn.disabled = false;
        bookNowBtn.innerHTML = originalBtnText;
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
